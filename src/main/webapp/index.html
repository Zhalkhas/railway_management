<!DOCTYPE html>

<html lang="en">

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="railway.css">
	<title>Railway Station</title>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

</head>

<body>
<div class = "container-fluid">
	<div class ="row">
		<h3>
			<button type="button" id="signin" onclick="openBox()">Sign In</button>
			<br>
		</h3>
	</div>

	<div class="profile">

		<form class="bevertical">
			<input type="text"  id="email" name="e-mail" placeholder="e-mail"><br>
			<input type="password" id="password" name="password" placeholder="password"><br>
			<button type="button" class="signButtons" onclick="signUpFunction()"><a style="text-decoration:none"
			                                                                        href="registration.html">Sign Up</a>
			</button>

			<button type="button" class="signButtons" onclick="signInFunction()"><a> Sign In</a></button>
		</form>
	</div>



		<div class ="row" class="d-flex justify-content-center">

			<div class="search" >
				<h3>
					FIND TICKETS
				</h3>

				<form>
					<input type="text" id="from" name="route_from" placeholder="From">
					<input type="text" id="to" name="route_to" placeholder="To">
					<input type="date" id="departureDate" data-date-inline-picker="true" name="departure_date"
					       placeholder="Departure date">
					<!--		<input type="date" id="returnDate" data-date-inline-picker="true" name="return_date" placeholder="Return date">-->

				</form>
				<button type="button" id="main_button" onclick="findFunction()">Find</button>
				<br>
			</div>
		</div>


	<div class ="row" id = "results">

		<section id="appWrapper">
			<ul class = "itemList" id ="listContent">

			</ul>
		</section>
	</div>
</div>
<div class="row">

</div>


<div class = "row">
	<div id="map"> </div>
</div>
<div class="row">

</div>
<script>

    let argDepTime;
    let argTrainID;
    let argFrom;
    let argTo;

    $('div.profile').hide();

    function openBox() {
        $('div.profile').toggle();
    }

    function signInFunction() {
        console.log($('#email').val());
        console.log($('#password').val());
        $.ajax({
            url: 'api/auth/login',
            data: {u: $('#email').val(), p: $('#password').val()},
        	contentType:'application/x-www-form-urlencoded',
        	method:'POST'
        }).done(function (r) {
        	console.log(r);
        	return r;
        });
    }

    function signUpFunction() {

    }

    function bookFunction() {

    }

    function findFunction() {
        document.getElementById("map").innerHTML = "";
        var from = $('#from').val();
        var to = $('#to').val();
        var departureDate = $('#departureDate').val();
        // var returnDate = $('#returnDate').val();

        $.get("api/search/getRoutes", {
                dept: from,
                dest: to,
                date: departureDate
            },

            function (r) {
                updateList(r);

            });
		// $.post("api/ticket/insertTicket", {
		// 		   ownerN: 'aida',
		// 		   ownerS: 'lastname',
		// 		   price: 6001,
		// 		   docId: 513211,
		// 		   usrID: 51,
		// 		   agentId: null,
		// 		   deptId: 503,
		// 		   destId: 504,
		// 		   depTime: '2019-11-04 12:29:30'
		// 	   },
		//
		// 	   function (r) {
		// 		   console.log("Working?")
		// 	   });
    }

    function updateList(items) {
        document.getElementById("listContent").innerHTML = "";
        $("#table_of_routes tbody tr").remove();
        $("#table_of_routes").html("");
        items = JSON.parse(items);
        let listItems = document.querySelector('.item');
        let lst = document.querySelector('.itemList');

        items.forEach(function (index) {
            var from = index.name1;
            var to = index.name2;
            var depTime = index.departureTime;
            var arrivalTime = index.arrivalTime;
            var trainID = index.trainId;
            console.log(from, to, depTime, arrivalTime, trainID);

            argTrainID = trainID;
            argDepTime = depTime;
            argFrom = from;
            argTo = to;

            lst.appendChild(document.createElement('li'));
            let lstChild = lst.lastChild;
            lstChild.innerHTML = "<p class='content' onclick=\"mapOpen()\"> From: " + from + " To: " + to + " Daparture time: " + depTime+ " Arrival time: "+ arrivalTime + " trainID: " + trainID + "</p> <button id ='book' onclick ='book( " +")'> Book </button>";
            lstChild.className = 'item';

        });
    }

    function book(){
        var queryString = "?" + argDepTime + "&" + argTrainID+"&" + argFrom+"&" + argTo;
        window.location.href='ticketinfo.html' + queryString;

    }

    var geocoder;
    var map;

    function mapOpen() {

        geocoder = new google.maps.Geocoder();
        var latlng = new google.maps.LatLng(51.124592, 71.425696);
        var mapOptions = {
            zoom: 8,
            center: latlng
        }
        map = new google.maps.Map(document.getElementById('map'), mapOptions);
	getRoute();
    }
    // var marker = new google.maps.Marker({position: uluru, map: map});

    function getRoute(){
        argDepTime = argDepTime.split(" ")[0];
        $.get("api/search/search", {
                dept: argFrom,
                dest: argTo,
                date: argDepTime
            },
	        function (r) {
                makeRoute(r);
            });
    }

    function makeRoute(r){
	    var route2 = JSON.parse(r);

        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);


        let cities = [];
        for (var i=1 ; i< route2.length-2; i++){
            cities.push({location: route2[i].name});

        }

        var request = {
            origin: route2[0].name,
            waypoints: cities,
            destination: route2[route2.length-1].name,
            travelMode: 'DRIVING'
        };

        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                directionsRenderer.setDirections(result);
            }
        });
    }


</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>

</html>
